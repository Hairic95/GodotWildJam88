name: "Build"

on:
    push:
        branches:
            - main
        tags:
            - "v*"

env:
    GODOT_VERSION: 4.5-stable
    EXPORT_NAME: "Snow Way, Bro"

jobs:
    # ----------------------------------------------
    # JOB 1: BUILD
    # This runs on every push to main AND every tag.
    # If this fails, the workflow stops here.
    # ----------------------------------------------
    build:
        name: Build for ${{ matrix.platform }}
        runs-on: ubuntu-latest
        container:
            image: barichello/godot-ci:4.5
        strategy:
            matrix:
                platform: [windows, linux, macos]
                include:
                    - platform: windows
                      preset: "Windows Desktop"
                      binary_name: "game.exe"
                    - platform: linux
                      preset: "Linux/X11"
                      binary_name: "game.x86_64"
                    - platform: macos
                      preset: "macOS"
                      binary_name: "game.zip"

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Install Dependencies
              run: |
                  apt-get update
                  apt-get install -y fontconfig libfontconfig1

            - name: Setup Godot
              uses: solarlabyrinth/action-setup-godot@v2
              with:
                  version: ${{ env.GODOT_VERSION }}

            # Import assets into cache separately to avoid export command from timing out
            - name: Import Assets
              run: |
                  echo "Opening project to force asset import..."
                  timeout 600 godot --headless --editor --quit || true

            - name: Setup Build Directory
              run: mkdir -p build/${{ matrix.platform }}

            - name: Export Game
              run: |
                  OUTPUT_PATH="build/${{ matrix.platform }}/${{ matrix.binary_name }}"

                  godot --headless --verbose --export-release "${{ matrix.preset }}" "$OUTPUT_PATH"

            - name: Archive Build
              run: |
                  cd build/${{ matrix.platform }}
                  
                  if [ "${{ matrix.platform }}" == "macos" ]; then
                      mv "${{ matrix.binary_name }}" ../../${{ env.EXPORT_NAME }}-${{ matrix.platform }}.zip
                  else
                      zip -r ../../${{ env.EXPORT_NAME }}-${{ matrix.platform }}.zip .
                  fi

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.platform }}-artifact
                  path: ${{ env.EXPORT_NAME }}-${{ matrix.platform }}.zip
                  if-no-files-found: error
